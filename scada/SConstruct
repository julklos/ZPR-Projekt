import platform, shutil, os

def copyLibBuilder( target, source, env):
   '''kopiuje biblioteke'''
   shutil.copy( str(source[0]), str(target[0]) )
   return

BOOST_CPPPATH = os.environ['BOOST_CPPPATH']
PQXX_CPPPATH = os.environ['PQXX_CPPPATH']
PYTHON_CPPPATH = os.environ['PYTHON_CPPPATH']

BOOST_LIBPATH = os.environ['BOOST_LIBPATH']
PQXX_LIBPATH = os.environ['PQXX_LIBPATH']
PYTHON_LIBPATH = os.environ['PYTHON_LIBPATH']

if(platform.system() == "Linux"):

    INCLUDE_DIR = "./include"
    BUILD_DIR = './build/'
    SRC_DIR = "./src"

    VariantDir(BUILD_DIR, SRC_DIR, duplicate=0)
    e = Environment(TARGET_ARCH='x86')

    sources = [Glob(BUILD_DIR + '*.cpp'),
               Glob(BUILD_DIR + 'utilities/*.cpp'), 
               Glob(BUILD_DIR + 'controllers/*.cpp'),
               Glob(BUILD_DIR + 'mappers/*.cpp'),
               Glob(BUILD_DIR + 'services/*.cpp')]

    e.Append( CPPFLAGS = '-Wall -pedantic -pthread -Wno-long-long -shared -Wextra' )
    e.Append( LINKFLAGS = '-Wall -pthread' )
    e.Append( CPPPATH = [INCLUDE_DIR,
                         BOOST_CPPPATH,
                         PQXX_CPPPATH,
                         PYTHON_CPPPATH] )


    
    e.Append( LIBPATH = ['.',
                         BOOST_LIBPATH,
                         PQXX_LIBPATH,
                         PYTHON_LIBPATH] )
                         

    e.Append( LIBS = [ 'boost_python36', 
        # 'boost_system', 
    'boost_date_time', 'pqxx' ] )

    target = 'scada.so'

elif(platform.system() == "Windows"):
    e = Environment(TARGET_ARCH='x86')

    e.Append( CPPFLAGS = ' /EHsc /D "WIN32" /D "_WIN32_WINNT#0x501" /D "_CONSOLE" /W4 /MD' )

    INCLUDE_DIR = '.\\include'
    BUILD_DIR = '.\\build'
    SRC_DIR = '.\\src'
    sources = ['src\\main.cpp' , 
                'src\\controllers\\DatabaseController.cpp',
                'src\\controllers\\MeasurementController.cpp',
                'src\\controllers\\SerializeDataController.cpp',
                'src\\controllers\\StateController.cpp',
                'src\\mappers\\Device.cpp',
                'src\\mappers\\Measurement.cpp',                
                'src\\services\\PostgreSQLService.cpp',
                'src\\services\\StateService.cpp',
                'src\\utilities\\extractKeyFromPythonDict.cpp',
                'src\\utilities\\pTimeToTimestamp.cpp',
                'src\\utilities\\timestampToPTime.cpp']

    e.Append( CPPPATH = [ INCLUDE_DIR, BOOST_CPPPATH, 
        PQXX_CPPPATH, 
        PYTHON_CPPPATH ] )
    e.Append( LIBPATH = [ BOOST_LIBPATH, 
        PQXX_LIBPATH, 
        PYTHON_LIBPATH ] )

    e.Append(LIBS = [
       'libboost_python36-vc140-mt-x32-1_69', 'libboost_date_time-vc140-mt-x32-1_69'
    , 'libpqxx', 'libpq' 
    ])

    target = 'libscada.pyd'
    
else:
    print(platform.system() + " not supported")

dll = e.SharedLibrary(target = 'scada', source = sources)
e.Command(target, dll, copyLibBuilder)

#build tests
env_test = Environment(TARGET_ARCH='x86')


if(platform.system() == "Linux"):
    INCLUDE_DIR = "./include"
    BUILD_DIR = './build/'
    SRC_DIR = "./src"

    env_test.Append( CPPFLAGS = '-Wall -pedantic -pthread -Wno-long-long -shared -Wextra' )
    env_test.Append( LINKFLAGS = '-Wall -pthread' )
    env_test.Append( CPPPATH = [INCLUDE_DIR,
                         BOOST_CPPPATH,
                         PQXX_CPPPATH,
                         PYTHON_CPPPATH] )
       
    env_test.Append( LIBPATH = ['.',
                         BOOST_LIBPATH,
                         PQXX_LIBPATH,
                         PYTHON_LIBPATH] )
                         
    env_test.Append( LIBS = [ 'scada',  'python3.6m', 'boost_unit_test_framework'] )
    env_test.Program( target = "__tests__/scada_test", source = '__tests__/scada_test.cpp')
   
elif(platform.system() == "Windows"):
    INCLUDE_DIR = '.\\include'
    BUILD_DIR = '.\\build'
    SRC_DIR = '.\\src'
    env_test.Append( CPPFLAGS = ' /EHsc /D "WIN32" /D "_WIN32_WINNT#0x501" /D "_CONSOLE" /W4 ' )
    env_test.Append( CPPPATH = [ INCLUDE_DIR, BOOST_CPPPATH, 
        PQXX_CPPPATH, 
        PYTHON_CPPPATH ] )
    env_test.Append( LIBPATH = [ BOOST_LIBPATH, 
        PQXX_LIBPATH, 
        PYTHON_LIBPATH ] )

    env_test.Append( LIBS = [ 'scada', 'libboost_unit_test_framework-vc140-mt-x32-1_69'] )
    env_test.Program( target = "__tests__/scada_test", source = '__tests__/scada_test.cpp')
